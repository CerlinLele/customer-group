# AWS Glue Terraform迁移指南

## 迁移概述

本指南说明如何将现有的Bash脚本部署方式迁移到Terraform管理。迁移后将获得以下优势：

- ✅ **版本控制**: 所有资源配置保存在Git中，可追溯变更历史
- ✅ **自动化部署**: 一条命令部署所有资源
- ✅ **幂等性**: 多次运行同样的命令结果一致
- ✅ **依赖管理**: 自动处理资源之间的依赖关系
- ✅ **配置灵活性**: JSON配置保持不变，易于维护

## 迁移前准备

### 1. 环境要求

```bash
# 检查Terraform版本
terraform version  # 需要 >= 1.14.0

# 检查AWS CLI
aws --version  # 需要 >= 2.0

# 检查jq (用于JSON处理)
jq --version
```

### 2. 备份现有资源

```bash
# 创建备份目录
mkdir -p backup

# 备份现有Glue资源
aws glue get-databases --region us-east-1 > backup/databases.json
aws glue get-crawlers --region us-east-1 > backup/crawlers.json
aws glue get-jobs --region us-east-1 > backup/jobs.json

# 备份IAM角色
aws iam get-role --role-name GlueCustomerDataRole > backup/iam-role.json

# 备份S3数据
aws s3 sync s3://your-customer-data-bucket/scripts/ backup/scripts/
```

### 3. 验证JSON配置

```bash
# 检查JSON格式是否正确
jq . glue_scripts/config/glue_jobs_config.json

# 检查脚本文件是否都存在
ls -la glue_scripts/*.py
```

## 迁移场景

### 场景1：全新环境部署（开发/测试）

**适用于**：新建环境，无现有Glue资源

#### 步骤

##### Step 1: 初始化Terraform

```bash
cd infra
terraform init
terraform fmt -recursive
terraform validate
```

**预期结果**：
- 初始化成功，没有错误
- 所有文件格式化正确

##### Step 2: 生成执行计划

```bash
terraform plan -out=tfplan
```

**检查点**：
- 确认要创建的资源数量（应该是18个）：1 IAM + 5 DB + 4 Crawler + 5 Job + 9 Trigger + 3 Alarm
- 确认S3路径已正确替换
- 确认IAM权限配置完整

**如果看到错误**：
- 检查`config_file_path`是否正确
- 检查JSON语法：`jq . glue_scripts/config/glue_jobs_config.json`

##### Step 3: 应用配置

```bash
terraform apply tfplan
```

**输出示例**：
```
Apply complete! Resources: 18 added, 0 changed, 0 destroyed.

Outputs:
glue_jobs = [
  "customer-data-cleansing",
  "customer-feature-engineering",
  ...
]
```

### 场景2：导入现有资源（生产环境）

**适用于**：已有Glue资源，需要纳入Terraform管理

#### 步骤

##### Step 1: 初始化Terraform（同场景1）

##### Step 2: 手动导入现有资源

###### 2.1 导入IAM角色

```bash
terraform import module.glue_pipeline.aws_iam_role.glue_role GlueCustomerDataRole
```

###### 2.2 导入数据库

```bash
# 导入所有数据库
terraform import module.glue_pipeline.aws_glue_catalog_database.databases["customer_raw_db"] customer_raw_db
terraform import module.glue_pipeline.aws_glue_catalog_database.databases["customer_cleaned_db"] customer_cleaned_db
terraform import module.glue_pipeline.aws_glue_catalog_database.databases["customer_feature_db"] customer_feature_db
terraform import module.glue_pipeline.aws_glue_catalog_database.databases["customer_segment_db"] customer_segment_db
terraform import module.glue_pipeline.aws_glue_catalog_database.databases["customer_recommendation_db"] customer_recommendation_db
```

###### 2.3 导入Crawlers

```bash
terraform import module.glue_pipeline.aws_glue_crawler.crawlers["customer-data-crawler"] customer-data-crawler
terraform import module.glue_pipeline.aws_glue_crawler.crawlers["cleaned-data-crawler"] cleaned-data-crawler
terraform import module.glue_pipeline.aws_glue_crawler.crawlers["feature-data-crawler"] feature-data-crawler
terraform import module.glue_pipeline.aws_glue_crawler.crawlers["segment-data-crawler"] segment-data-crawler
```

###### 2.4 导入Jobs

```bash
terraform import module.glue_pipeline.aws_glue_job.jobs["customer-data-cleansing"] customer-data-cleansing
terraform import module.glue_pipeline.aws_glue_job.jobs["customer-feature-engineering"] customer-feature-engineering
terraform import module.glue_pipeline.aws_glue_job.jobs["customer-segmentation"] customer-segmentation
terraform import module.glue_pipeline.aws_glue_job.jobs["marketing-recommendation"] marketing-recommendation
terraform import module.glue_pipeline.aws_glue_job.jobs["data-quality-monitoring"] data-quality-monitoring
```

###### 2.5 导入Triggers（如果已创建）

```bash
# 导入scheduled triggers
terraform import module.glue_pipeline.aws_glue_trigger.scheduled_triggers["customer-data-cleansing"] customer-data-cleansing-scheduled-trigger

# ... 导入其他triggers ...
```

**注意**：如果现有Triggers与JSON配置不匹配，需要先删除现有Trigger，让Terraform重新创建。

##### Step 3: 验证导入结果

```bash
# 生成执行计划
terraform plan

# 预期输出：0 to add, X to change, 0 to destroy
# (可能会显示一些属性变化，这是因为Terraform和AWS API的差异，无需关注)
```

##### Step 4: 应用配置变化（如果有）

```bash
terraform apply
```

## 导入脚本自动化

为了加快导入过程，创建自动化脚本：

```bash
#!/bin/bash
# import_glue_resources.sh - 自动导入所有Glue资源

set -e

CONFIG_FILE="glue_scripts/config/glue_jobs_config.json"

echo "=== 导入IAM角色 ==="
terraform import module.glue_pipeline.aws_iam_role.glue_role GlueCustomerDataRole

echo "=== 导入数据库 ==="
jq -r '.databases[] | "terraform import module.glue_pipeline.aws_glue_catalog_database.databases[\"\(.database_name)\"] \(.database_name)"' \
  "$CONFIG_FILE" | bash

echo "=== 导入Crawlers ==="
jq -r '.crawlers[] | "terraform import module.glue_pipeline.aws_glue_crawler.crawlers[\"\(.crawler_name)\"] \(.crawler_name)"' \
  "$CONFIG_FILE" | bash

echo "=== 导入Jobs ==="
jq -r '.glue_jobs[] | "terraform import module.glue_pipeline.aws_glue_job.jobs[\"\(.job_name)\"] \(.job_name)"' \
  "$CONFIG_FILE" | bash

echo "=== 导入完成 ==="
terraform plan  # 验证导入结果
```

## 验证和测试

### 1. 检查Terraform状态

```bash
# 查看所有Glue资源
terraform state list | grep glue

# 输出示例：
# module.glue_pipeline.aws_glue_catalog_database.databases["customer_raw_db"]
# module.glue_pipeline.aws_glue_crawler.crawlers["customer-data-crawler"]
# module.glue_pipeline.aws_glue_job.jobs["customer-data-cleansing"]
# ...
```

### 2. 查看资源详情

```bash
# 查看特定Job的配置
terraform state show module.glue_pipeline.aws_glue_job.jobs[\"customer-data-cleansing\"]

# 验证S3路径是否正确
aws glue get-job --job-name customer-data-cleansing --region us-east-1
```

### 3. 功能测试

```bash
# 测试Crawler
aws glue start-crawler --name customer-data-crawler --region us-east-1
aws glue get-crawler --name customer-data-crawler --region us-east-1

# 查看Crawler运行状态
aws glue get-crawler-metrics --crawler-name customer-data-crawler --region us-east-1

# 测试Job
aws glue start-job-run --job-name customer-data-cleansing --region us-east-1

# 查看Job运行状态
aws glue get-job-runs --job-name customer-data-cleansing --max-results 1 --region us-east-1

# 查看CloudWatch日志
aws logs tail /aws-glue/jobs/output --follow --region us-east-1
```

### 4. 数据验证

```bash
# 等待Crawler完成后，使用Athena查询
aws athena start-query-execution \
  --query-string "SELECT COUNT(*) FROM customer_raw_db.raw_customer_base" \
  --result-configuration "OutputLocation=s3://your-bucket/athena-results/" \
  --region us-east-1

# 查看查询结果
aws athena get-query-results --query-execution-id <query-execution-id> --region us-east-1
```

## 迁移前后对比

### 部署流程对比

| 操作 | 迁移前（Bash） | 迁移后（Terraform） |
|------|---|---|
| 创建资源 | `bash deploy.sh` | `terraform apply` |
| 更新配置 | 修改脚本 + 重新运行 | 修改JSON + `terraform apply` |
| 删除资源 | 手动AWS CLI | `terraform destroy` |
| 查看资源 | AWS CLI查询 | `terraform state list` |
| 版本控制 | 无 | Git + Terraform State |
| 回滚变更 | 不支持 | `git checkout` + `terraform apply` |

### 配置管理对比

**迁移前**：
```bash
# 配置分散在多个地方
glue_scripts/deploy.sh        # 部署脚本
glue_scripts/config/...       # JSON配置
glue_scripts/*.py             # Python脚本
```

**迁移后**：
```bash
# 配置集中管理
infra/main.tf                 # 模块调用
infra/modules/glue/*.tf       # 资源定义
glue_scripts/config/...       # JSON配置（保持不变）
glue_scripts/*.py             # Python脚本（保持不变）

# 所有变更都在Git中追踪
git log infra/
git diff infra/
```

## 常见问题FAQ

### Q1: 迁移后还能使用deploy.sh吗？

**A**: 不建议。迁移后应使用Terraform管理资源，两者混用会导致状态不一致。

可以保留deploy.sh作为参考，但添加废弃说明：
```bash
echo "# DEPRECATED: This script is replaced by Terraform" >> glue_scripts/deploy.sh
```

### Q2: 如何回滚迁移？

**A**:
```bash
# 方法1：删除Terraform创建的资源，恢复原始配置
terraform destroy
bash glue_scripts/deploy.sh

# 方法2：使用Git回滚Terraform配置
git checkout HEAD~1 infra/
terraform apply
```

### Q3: JSON配置需要迁移吗？

**A**: 不需要。Terraform直接读取现有JSON配置，完全向后兼容。

### Q4: 修改Job配置需要重启Job吗？

**A**: 修改JSON配置后，运行`terraform apply`会更新Job配置。但正在运行的Job实例会继续使用旧配置，需要等待完成或手动停止。

### Q5: 如何处理资源冲突？

**A**: 如果资源已存在（由deploy.sh创建），Terraform会报告冲突。使用`terraform import`导入现有资源。

### Q6: 可以逐步迁移吗？

**A**: 可以。但不建议长期混用Bash和Terraform。建议：
1. 在开发环境完整测试Terraform配置
2. 验证等同性（创建相同的资源）
3. 在生产环境导入现有资源
4. 替换所有部署脚本

## 迁移检查清单

- [ ] 备份所有现有资源
- [ ] 验证JSON配置格式
- [ ] 运行`terraform init`
- [ ] 运行`terraform validate`
- [ ] 运行`terraform plan`并检查变更
- [ ] 运行`terraform apply`或导入现有资源
- [ ] 验证所有资源创建成功
- [ ] 功能测试（Crawler、Job、Trigger）
- [ ] 数据验证
- [ ] 删除或废弃deploy.sh
- [ ] 提交Terraform配置到Git
- [ ] 更新团队文档和流程

## 故障排查

### 错误：`config_file_path` 不存在

```
Error: Failed to read configuration: open ../../glue_scripts/config/glue_jobs_config.json: no such file or directory
```

**解决**:
```bash
# 确保从infra目录运行terraform
cd infra

# 检查JSON文件路径
ls -la ../glue_scripts/config/glue_jobs_config.json
```

### 错误：JSON格式不正确

```
Error: Invalid JSON in config file: invalid character
```

**解决**:
```bash
# 验证JSON格式
jq . glue_scripts/config/glue_jobs_config.json

# 修复格式错误后重试
terraform validate
```

### 错误：IAM权限不足

```
Error: error creating IAM role: AccessDenied
```

**解决**:
```bash
# 检查AWS凭证
aws sts get-caller-identity

# 确保有以下权限：
# - iam:CreateRole
# - iam:PutRolePolicy
# - iam:AttachRolePolicy
# - glue:CreateDatabase
# - glue:CreateCrawler
# - glue:CreateJob
```

### 错误：资源已存在

```
Error: Error creating Glue Crawler: CrawlerAlreadyExistsException
```

**解决**:
```bash
# 导入现有资源
terraform import module.glue_pipeline.aws_glue_crawler.crawlers["customer-data-crawler"] customer-data-crawler

# 重新运行plan
terraform plan
```

## 后续维护

### 添加新Job

1. 编写Python脚本
2. 上传到S3：
   ```bash
   aws s3 cp glue_scripts/new_job.py s3://bucket/scripts/
   ```
3. 在JSON中添加Job配置
4. 运行Terraform：
   ```bash
   terraform plan
   terraform apply
   ```

### 修改配置

1. 编辑JSON配置
2. 运行Terraform：
   ```bash
   terraform plan   # 查看变更
   terraform apply  # 应用变更
   ```

### 删除资源

1. 从JSON中移除配置
2. 运行Terraform：
   ```bash
   terraform plan   # 确认要删除
   terraform apply
   ```

## 相关资源

- [Terraform文档](https://www.terraform.io/docs)
- [AWS Provider文档](https://registry.terraform.io/providers/hashicorp/aws/latest/docs)
- [AWS Glue文档](https://docs.aws.amazon.com/glue/)
- [模块使用说明](../infra/modules/glue/README.md)
