# AWS 特征工程云端处理方案

## 项目现状

- **数据规模**：26.2 MB（10K 客户 + 120K 月度记录）
- **数据增长**：线性增长，3年内预计 79 MB（仍为小-中规模）
- **技术栈**：Python 3.10, Pandas, DVC, Hydra, Flask
- **当前状态**：特征工程计划完善，代码实施未启动
- **计划特征**：100+ 个特征，4个阶段实施

## AWS 方案对比

### 方案 A：成本最优（推荐用于快速启动）
**核心服务**：AWS Glue + S3 + Lambda

**架构**：
```
S3 Raw (CSV)
  ↓
AWS Glue Job (特征工程)
  ↓
S3 Processed (特征矩阵)
  ↓
Lambda 定时调度
```

**优势**：
- 成本最低（~$5-10/月）
- 无需管理基础设施
- 与 DVC 相比更云原生
- 支持 Python、Spark 脚本

**劣势**：
- 冷启动延迟
- 不适合实时查询

**适用场景**：月度离线特征生成

---

### 方案 B：扩展性最好（推荐用于模型开发）
**核心服务**：AWS SageMaker + S3 + Redshift

**架构**：
```
S3 Raw
  ↓
SageMaker Processing (特征工程)
  ↓
S3 Processed
  ↓
Redshift (数据仓库)
  ↓
SageMaker Training (模型训练)
```

**优势**：
- 一站式 ML 平台
- 集特征工程、训练、部署于一体
- 支持 Spark/Pandas/自定义容器
- 易于扩展到大规模数据

**劣势**：
- 成本较高（~$20-50/月）
- 学习曲线陡峭

**适用场景**：完整 ML 工作流，从特征到模型部署

---

### 方案 C：轻量级方案（推荐用于快速验证）
**核心服务**：AWS Lambda + S3 + Pandas Layer

**架构**：
```
S3 Raw
  ↓
Lambda Function (Python)
  ↓
S3 Processed
```

**优势**：
- 极低成本（$0-2/月）
- 部署简单（一个 ZIP 文件）
- 冷启动快（对于小数据量）

**劣势**：
- Lambda 超时限制（15 分钟）
- 不适合大规模数据处理
- 内存限制（3GB）

**适用场景**：快速验证、小规模定时任务

---

## 推荐分阶段实施

### Phase 1：快速上云（第 1-2 周）
**选择：方案 C (Lambda) + 方案 A (Glue)**

实施步骤：
1. 配置 AWS 账户和 S3 bucket
2. 上传 customer_base.csv 和 customer_behavior_assets.csv 到 S3
3. 使用 Glue Jupyter 或本地编写特征工程脚本
4. 部署 Glue Job（支持 Python 和 Spark）
5. 设置 Lambda 定时任务（月初触发特征生成）
6. 特征矩阵输出到 S3 Processed 层

**成本**：~$5-10/月

---

### Phase 2：建立数据仓库（第 3-4 周）
**添加：Redshift Spectrum 或轻量级 Redshift**

步骤：
1. 配置 Redshift（可选择按需集群降低成本）
2. 创建外部表指向 S3 Processed 层
3. 使用 SQL 进行特征验证和聚合分析
4. 集成 QuickSight 进行可视化

**增加成本**：~$10-15/月

---

### Phase 3：模型开发与部署（第 5-6 周）
**升级至方案 B (SageMaker)**

步骤：
1. 迁移特征工程到 SageMaker Processing Jobs
2. 在 SageMaker 中训练分群模型
3. 部署为 SageMaker Endpoint（实时预测）或 Batch Transform（离线预测）
4. 集成到现有 Flask dashboard

**增加成本**：~$15-30/月

---

## 架构对比表

| 维度 | 方案 A（Glue） | 方案 B（SageMaker） | 方案 C（Lambda） |
|------|----------------|-------------------|-----------------|
| **成本** | $5-10/月 | $20-50/月 | $0-2/月 |
| **处理时间** | 2-5 分钟 | 5-15 分钟 | 2-10 分钟 |
| **可扩展性** | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐ |
| **易用性** | ⭐⭐⭐ | ⭐⭐ | ⭐⭐⭐⭐ |
| **集成 ML** | ⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐ |
| **实时查询** | ❌ | ✅ (Redshift) | ❌ |
| **数据量上限** | 无限 | 无限 | 3GB/运行 |

---

## 立即可行的 AWS 方案架构

```
┌─────────────────────────────────────────────────────────────┐
│                    AWS Cloud Deployment                     │
└─────────────────────────────────────────────────────────────┘

1. 数据存储层 (S3)
   ├─ s3://bucket-name/raw/
   │  ├─ customer_base.csv
   │  └─ customer_behavior_assets.csv
   ├─ s3://bucket-name/processed/
   │  ├─ features_v1/features.csv
   │  ├─ features_v2/features.csv
   │  └─ ...
   └─ s3://bucket-name/archive/  (历史版本)

2. 特征工程处理 (选择一种)
   ├─ AWS Glue Job (推荐)
   │  └─ Python 脚本执行特征工程
   ├─ SageMaker Processing (中期)
   │  └─ 支持大规模分布式处理
   └─ Lambda (快速验证)
      └─ 简单特征计算

3. 调度与触发 (EventBridge + Lambda)
   └─ 每月初自动触发特征生成

4. 数据分析 (可选)
   ├─ Redshift (数据仓库)
   ├─ Athena (SQL 查询)
   └─ QuickSight (可视化仪表板)

5. 模型开发 (长期)
   ├─ SageMaker Notebook (开发)
   ├─ SageMaker Training (模型训练)
   └─ SageMaker Endpoint (模型部署)
```

---

## 关键决策点

### 1. 存储方案：S3 vs RDS
- **选择 S3**：数据量小，成本低，支持版本控制
- 迁移 DVC 版本管理到 S3 版本控制功能

### 2. 处理引擎：Glue vs SageMaker vs Lambda
- **现在**：用 Glue（成本低，功能全）
- **后期**：升级到 SageMaker（支持分布式和 ML 集成）

### 3. 特征版本管理
- 使用 S3 文件夹分版本（features_v1, features_v2...）
- 元数据记录在 DynamoDB 或 S3 JSON 文件

### 4. 成本控制
- S3：启用生命周期策略，老版本数据转 Glacier
- Glue：按使用次数计费，月初运行一次
- 整体月成本控制在 $10-20

---

## 实施优先级

### Priority 1（第 1 周）
- ✅ 创建 S3 bucket 和文件夹结构
- ✅ 上传原始数据
- ✅ 使用 Glue Studio 或编写 Glue Job
- ✅ 实现 Phase 1 基础特征工程

### Priority 2（第 2-3 周）
- ✅ 设置 Lambda 定时任务
- ✅ 自动化特征生成流程
- ✅ 特征验证和质量检查

### Priority 3（第 4-6 周）
- ✅ 添加 Redshift/Athena 支持
- ✅ SageMaker 模型开发
- ✅ 生产部署和监控

---

## 为什么选 AWS Glue（第一优选）

1. **成本**：按 DPU 时间计费，小任务几毛钱
2. **无需管理**：无服务器，自动扩展
3. **Spark 支持**：支持大规模分布式处理
4. **Python 友好**：直接使用 Pandas，迁移成本低
5. **与 DVC 互补**：S3 替代本地存储，DVC 可选
6. **易于升级**：后期可无缝迁移到 SageMaker

---

## 下一步建议

1. **立即**：选择方案（建议 A + C 组合）
2. **本周**：创建 AWS 账户，配置 S3 和 Glue
3. **下周**：迁移第一个 Glue Job，测试特征生成
4. **第三周**：添加自动化调度和监控
5. **第四周+**：逐步添加 Redshift 和 SageMaker
