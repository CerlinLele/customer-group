# VPC 部署检查清单

## 部署前检查

### 规划阶段

- [ ] 确定 VPC CIDR 块（例如 10.0.0.0/16）
- [ ] 规划子网 CIDR 块
- [ ] 确定可用区分布
- [ ] 规划安全组规则
- [ ] 确定是否需要 NAT Gateway
- [ ] 确定是否需要 VPN 连接

### 权限检查

- [ ] 验证 AWS 账户权限
- [ ] 检查 IAM 用户/角色权限
- [ ] 确认有 EC2、VPC 权限
- [ ] 确认有 Glue 权限

### 资源检查

- [ ] 检查 VPC 配额
- [ ] 检查子网配额
- [ ] 检查安全组配额
- [ ] 检查 Elastic IP 配额

## 部署阶段

### VPC 创建

- [ ] 创建 VPC
- [ ] 验证 VPC 创建成功
- [ ] 记录 VPC ID
- [ ] 添加 VPC 标签

### 子网创建

- [ ] 创建公有子网
- [ ] 创建私有子网
- [ ] 验证子网创建成功
- [ ] 记录子网 ID
- [ ] 添加子网标签

### 互联网网关

- [ ] 创建互联网网关
- [ ] 附加到 VPC
- [ ] 验证附加成功
- [ ] 添加标签

### 路由表

- [ ] 创建公有路由表
- [ ] 添加到互联网网关的路由
- [ ] 关联公有子网
- [ ] 创建私有路由表
- [ ] 关联私有子网

### NAT Gateway（可选）

- [ ] 分配 Elastic IP
- [ ] 创建 NAT Gateway
- [ ] 在私有路由表中添加路由
- [ ] 验证 NAT Gateway 状态

### 安全组

- [ ] 创建 Glue 安全组
- [ ] 添加入站规则（Spark 通信）
- [ ] 添加出站规则
- [ ] 创建数据库安全组（如需要）
- [ ] 添加数据库安全组规则

### VPC 端点（可选）

- [ ] 创建 S3 VPC 端点
- [ ] 创建 Glue VPC 端点
- [ ] 创建 CloudWatch VPC 端点
- [ ] 验证端点状态

## 配置阶段

### Glue 配置

- [ ] 更新 Terraform 配置
- [ ] 添加 VPC ID
- [ ] 添加子网 ID
- [ ] 添加安全组 ID
- [ ] 验证 Terraform 配置

### IAM 配置

- [ ] 创建 Glue IAM 角色
- [ ] 添加 S3 权限
- [ ] 添加 EC2 VPC 权限
- [ ] 添加 CloudWatch 权限
- [ ] 验证 IAM 角色

### 部署

- [ ] 运行 `terraform plan`
- [ ] 审查变更
- [ ] 运行 `terraform apply`
- [ ] 验证部署成功

## 验证阶段

### VPC 验证

- [ ] 验证 VPC 存在
- [ ] 验证子网存在
- [ ] 验证路由表配置
- [ ] 验证安全组规则

### Glue 验证

- [ ] 查看 Glue Job 配置
- [ ] 验证 VPC 配置
- [ ] 验证安全组配置
- [ ] 运行测试 Job

### 网络验证

- [ ] 测试 Glue 到 S3 的连接
- [ ] 测试 Glue 到数据库的连接（如需要）
- [ ] 检查 CloudWatch 日志
- [ ] 验证无网络错误

### 性能验证

- [ ] 运行数据清洗 Job
- [ ] 检查执行时间
- [ ] 检查资源使用
- [ ] 验证输出数据

## 部署后检查

### 监控设置

- [ ] 启用 VPC Flow Logs
- [ ] 设置 CloudWatch 告警
- [ ] 配置日志保留期
- [ ] 设置成本告警

### 文档更新

- [ ] 记录 VPC ID
- [ ] 记录子网 ID
- [ ] 记录安全组 ID
- [ ] 更新架构文档

### 备份和恢复

- [ ] 备份 Terraform 状态
- [ ] 备份 VPC 配置
- [ ] 测试恢复流程
- [ ] 文档化恢复步骤

### 安全审计

- [ ] 审查安全组规则
- [ ] 审查 IAM 权限
- [ ] 审查 VPC 配置
- [ ] 检查是否有不必要的开放端口

## 故障排除检查

### 连接问题

- [ ] 检查安全组规则
- [ ] 检查网络 ACL
- [ ] 检查路由表
- [ ] 检查 VPC 端点

### 性能问题

- [ ] 检查 NAT Gateway 状态
- [ ] 检查网络带宽
- [ ] 检查 Glue worker 配置
- [ ] 检查数据大小

### 权限问题

- [ ] 检查 IAM 角色
- [ ] 检查 IAM 策略
- [ ] 检查 S3 bucket 策略
- [ ] 检查 KMS 密钥权限

## 清单使用说明

1. **部署前**: 完成"部署前检查"部分
2. **部署中**: 按顺序完成各阶段检查
3. **部署后**: 完成"部署后检查"部分
4. **问题排查**: 根据问题类型查看"故障排除检查"

## 相关文档

- [VPC 快速开始](./01_QUICK_START.md)
- [VPC 快速参考](./03_QUICK_REFERENCE.md)
- [Spark 连接失败问题](../glue/issues/01_SPARK_CONNECTION_FAILURE.md)

---

**最后更新**: 2025-12-10
