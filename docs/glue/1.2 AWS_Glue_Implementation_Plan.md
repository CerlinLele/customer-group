# AWS Glue æ•°æ®å¤„ç†æ–¹æ¡ˆè®¾è®¡

## ğŸ“Œ æ¦‚è¿°

åŸºäºå®¢æˆ·æ•°æ®EDAçš„åˆ†æç»“æœï¼Œè®¾è®¡ä¸€å¥—å®Œæ•´çš„AWS Glue ETLå¤„ç†æ–¹æ¡ˆï¼Œç”¨äºæ•°æ®æ¸…æ´—ã€è½¬æ¢ã€èšåˆå’Œå»ºæ¨¡ã€‚

---

## 1ï¸âƒ£ æ¶æ„è®¾è®¡

### æ•´ä½“æ•°æ®æµ

```
æ•°æ®æº (S3)
    â†“
AWS Glue Crawler (è‡ªåŠ¨å‘ç°å…ƒæ•°æ®)
    â†“
Glue Catalog (æ•°æ®ç›®å½•)
    â†“
Glue ETL Jobs (PySparkå¤„ç†)
    â†“
å¤„ç†åæ•°æ® (S3)
    â†“
Athena/BIå·¥å…· (æŸ¥è¯¢åˆ†æ)
```

### åˆ†å±‚æ¶æ„

```
Raw Layer (åŸå§‹å±‚)
  - customer_base.csv
  - customer_behavior_assets.csv

â†“ (Glue ETL)

Cleaned Layer (æ¸…æ´—å±‚)
  - Standardized data
  - ç¼ºå¤±å€¼å¤„ç†
  - æ•°æ®ç±»å‹è§„èŒƒåŒ–

â†“ (Glue ETL)

Feature Layer (ç‰¹å¾å±‚)
  - åˆ†å±‚æ ‡ç­¾
  - è¡Œä¸ºæŒ‡æ ‡
  - RFMåˆ†æ

â†“ (Glue ETL)

Business Layer (ä¸šåŠ¡å±‚)
  - å®¢æˆ·åˆ†ç¾¤ç»“æœ
  - è¥é”€æ¨è
  - é£é™©è¯„åˆ†
```

---

## 2ï¸âƒ£ æ•°æ®å¤„ç†éœ€æ±‚åˆ†æ

### 2.1 EDAå‘ç°çš„é—®é¢˜éœ€è¦å¤„ç†

| é—®é¢˜ | ä¼˜å…ˆçº§ | å¤„ç†æ–¹æ³• |
|-----|--------|--------|
| contact_resultç¼ºå¤±15% | ğŸ”´é«˜ | åŸºäºå†å²æ•°æ®æ¨æ–­æˆ–æ ‡è®° |
| èµ„äº§æ•°æ®ä¸¥é‡å³å | ğŸŸ¡ä¸­ | æ—¥å¿—è½¬æ¢ã€åˆ†ä½æ•°å¤„ç† |
| æ¶ˆè´¹/æŠ•èµ„å®¢æˆ·åˆ†åŒ– | ğŸŸ¢ä½ | åˆ†ç¾¤å¤„ç†ï¼Œåˆ›å»ºæ ‡ç­¾ |
| æ—¶é—´åºåˆ—æ•°æ®å†—ä½™ | ğŸŸ¡ä¸­ | èšåˆåˆ°æœ€æ–°æœˆä»½ |

### 2.2 å…³é”®å¤„ç†ä»»åŠ¡

#### Task 1: æ•°æ®æ¸…æ´—ä¸æ ‡å‡†åŒ–
- ç»Ÿä¸€æ—¶é—´æ ¼å¼
- å¤„ç†ç©ºå€¼
- æ•°æ®ç±»å‹è½¬æ¢
- å¼‚å¸¸å€¼æ£€æµ‹

#### Task 2: ç‰¹å¾å·¥ç¨‹
- å®¢æˆ·ç”Ÿå‘½å‘¨æœŸæ ‡ç­¾
- èµ„äº§åˆ†å±‚æ ‡ç­¾
- è¡Œä¸ºè¯„åˆ†ï¼ˆRFMï¼‰
- äº§å“äº¤å‰é”€å”®æŒ‡æ•°

#### Task 3: å®¢æˆ·åˆ†ç¾¤
- åŸºäºèµ„äº§Ã—æ¶ˆè´¹Ã—æŠ•èµ„çš„3ç»´åˆ†ç¾¤
- ç”Ÿæˆå®¢æˆ·åˆ†å±‚è¡¨

#### Task 4: è¥é”€æ¨è
- ä¸ºæ¯ä¸ªå®¢æˆ·è¯„åˆ†å‡çº§åˆ°å„äº§å“çš„æ¦‚ç‡
- ç”Ÿæˆä¼˜å…ˆè¥é”€æ¸…å•

#### Task 5: æ•°æ®è´¨é‡ç›‘æ§
- æ•°æ®è¡Œæ•°ç›‘æ§
- å¼‚å¸¸å€¼å‘Šè­¦
- ç¼ºå¤±ç‡ç›‘æ§

---

## 3ï¸âƒ£ AWS Glue å®ç°æ–¹æ¡ˆ

### 3.1 Glue Crawleré…ç½®

**Job 1: Raw Data Crawler**
```yaml
åç§°: customer-data-crawler
æ•°æ®æº: s3://your-bucket/raw/
è¾“å‡ºæ•°æ®åº“: customer_raw_db
è¡¨å‰ç¼€: raw_
è°ƒåº¦: æ¯æ—¥ 00:00 UTC
```

**è‡ªåŠ¨ç”Ÿæˆçš„è¡¨**ï¼š
- `raw_customer_base`
- `raw_customer_behavior_assets`

### 3.2 Glue Jobsè®¾è®¡

#### Job 1: Data Cleansing Job
**è¾“å…¥**:
- raw_customer_base
- raw_customer_behavior_assets

**å¤„ç†é€»è¾‘**:
1. æ•°æ®ç±»å‹è½¬æ¢
2. æ—¶é—´å­—æ®µæ ‡å‡†åŒ–
3. ç¼ºå¤±å€¼å¤„ç†
4. å»é‡

**è¾“å‡º**:
- s3://bucket/cleaned/customer_base/
- s3://bucket/cleaned/customer_behavior/

**è¿è¡Œå‘¨æœŸ**: æ¯æ—¥å‡Œæ™¨

---

#### Job 2: Feature Engineering Job
**è¾“å…¥**:
- cleaned_customer_base
- cleaned_customer_behavior

**ç”Ÿæˆç‰¹å¾**:
- `lifecycle_stage` â†’ `lifecycle_score` (0-100)
- `total_assets` â†’ `asset_tier` (æ ‡å‡†åŒ–åˆ†å±‚)
- è¡Œä¸ºæŒ‡æ ‡ â†’ `engagement_score`
- äº§å“æŒæœ‰ â†’ `product_cross_sell_index`

**è¾“å‡º**:
- s3://bucket/features/customer_features/

**è¿è¡Œå‘¨æœŸ**: æ¯æ—¥ 02:00 UTC

---

#### Job 3: Customer Segmentation Job
**è¾“å…¥**:
- customer_features

**èšç±»ç»´åº¦**:
1. **èµ„äº§ç»´åº¦** (total_assets)
2. **æ¶ˆè´¹ç»´åº¦** (credit_card_monthly_expense)
3. **æ´»è·ƒç»´åº¦** (engagement_score)

**è¾“å‡º**:
- `segment_id` (ç»†åˆ†ç¾¤ä½“ID)
- `segment_name` (äººç±»å¯è¯»çš„ç¾¤ä½“åç§°)
- `segment_characteristics` (ç¾¤ä½“ç‰¹å¾è¯´æ˜)

**åˆ†ç¾¤ç¤ºä¾‹**:
```
S001: é«˜å‡€å€¼æ´»è·ƒæŠ•èµ„å®¢æˆ· (èµ„äº§100ä¸‡+, æ´»è·ƒ, é«˜æŠ•èµ„)
S002: é«˜å‡€å€¼ä½æ´»è·ƒå®¢æˆ· (èµ„äº§100ä¸‡+, ä½æ´»è·ƒ)
S003: ä¸­ç«¯æ´»è·ƒå®¢æˆ· (èµ„äº§50-100ä¸‡, æ´»è·ƒ)
S004: æ–°å®¢æˆ·åŸ¹è‚²æœŸ (lifecycle=æ–°å®¢æˆ·)
... æ€»è®¡ 10-12 ä¸ªç»†åˆ†ç¾¤ä½“
```

**è¾“å‡º**: s3://bucket/segments/customer_segments/

**è¿è¡Œå‘¨æœŸ**: æ¯å‘¨ä¸€ 04:00 UTC

---

#### Job 4: Marketing Recommendation Job
**è¾“å…¥**:
- customer_features
- customer_segments

**ç”Ÿæˆæ¨è**:
1. **ç†è´¢äº§å“æ¨èåˆ†æ•°** (åŸºäºï¼šå­˜æ¬¾å®¢æˆ·+é«˜æ”¶å…¥)
2. **åŸºé‡‘äº§å“æ¨èåˆ†æ•°** (åŸºäºï¼šé£é™©åå¥½+æ´»è·ƒåº¦)
3. **ä¿é™©äº§å“æ¨èåˆ†æ•°** (åŸºäºï¼šå·²å©š+ä¸­é«˜æ”¶å…¥)
4. **ä¿¡ç”¨å¡å‡çº§æ¨è** (åŸºäºï¼šæ¶ˆè´¹å†å²)

**ä¼˜å…ˆçº§è®¡ç®—**:
```
ä¼˜å…ˆçº§ = æ¨èåˆ†æ•° Ã— è´­ä¹°æ¦‚ç‡ Ã— é¢„æœŸå®¢æˆ·ä»·å€¼
```

**è¾“å‡º**:
- s3://bucket/recommendations/marketing_targets/
- åŒ…å«å­—æ®µï¼šcustomer_id, recommended_product, priority_score, expected_value

**è¿è¡Œå‘¨æœŸ**: æ¯å‘¨ä¸€ 05:00 UTC

---

#### Job 5: Data Quality Monitoring Job
**ç›‘æ§æŒ‡æ ‡**:
- æºè¡¨è¡Œæ•° vs ç›®æ ‡è¡¨è¡Œæ•°
- ç¼ºå¤±å€¼ç‡å˜åŒ–
- å¼‚å¸¸å€¼æ£€æµ‹ (å¹´é¾„<18 æˆ– >100)
- æœ€åæ›´æ–°æ—¶é—´

**è¾“å‡º**: CloudWatch Metrics + SNS å‘Šè­¦

**è¿è¡Œå‘¨æœŸ**: æ¯æ—¥ 06:00 UTC

---

### 3.3 Glue Catalog ç»“æ„

```
Databases:
â”œâ”€â”€ customer_raw_db
â”‚   â”œâ”€â”€ raw_customer_base
â”‚   â””â”€â”€ raw_customer_behavior_assets
â”œâ”€â”€ customer_cleaned_db
â”‚   â”œâ”€â”€ cleaned_customer_base
â”‚   â””â”€â”€ cleaned_customer_behavior
â”œâ”€â”€ customer_feature_db
â”‚   â”œâ”€â”€ customer_features
â”‚   â””â”€â”€ behavior_metrics
â”œâ”€â”€ customer_segment_db
â”‚   â”œâ”€â”€ customer_segments
â”‚   â””â”€â”€ segment_profiles
â””â”€â”€ customer_recommendation_db
    â”œâ”€â”€ marketing_targets
    â””â”€â”€ product_recommendations
```

---

## 4ï¸âƒ£ å…·ä½“å®ç°ä»£ç 

### ä»£ç æ–‡ä»¶ç»“æ„

```
glue-scripts/
â”œâ”€â”€ 1_data_cleansing.py          # æ•°æ®æ¸…æ´—
â”œâ”€â”€ 2_feature_engineering.py     # ç‰¹å¾å·¥ç¨‹
â”œâ”€â”€ 3_customer_segmentation.py   # å®¢æˆ·åˆ†ç¾¤
â”œâ”€â”€ 4_marketing_recommendation.py # è¥é”€æ¨è
â”œâ”€â”€ 5_data_quality_monitoring.py # è´¨é‡ç›‘æ§
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ data_validator.py        # æ•°æ®æ ¡éªŒå·¥å…·
â”‚   â”œâ”€â”€ feature_builder.py       # ç‰¹å¾æ„å»ºå·¥å…·
â”‚   â””â”€â”€ logger.py                # æ—¥å¿—å·¥å…·
â””â”€â”€ config/
    â”œâ”€â”€ database_config.json     # æ•°æ®åº“é…ç½®
    â””â”€â”€ job_config.json          # ä»»åŠ¡é…ç½®
```

---

## 5ï¸âƒ£ éƒ¨ç½²æ­¥éª¤

### Step 1: å‡†å¤‡S3å­˜å‚¨

```bash
# åˆ›å»ºS3ç›®å½•ç»“æ„
s3://your-customer-bucket/
â”œâ”€â”€ raw/
â”‚   â”œâ”€â”€ customer_base/
â”‚   â””â”€â”€ customer_behavior_assets/
â”œâ”€â”€ cleaned/
â”‚   â”œâ”€â”€ customer_base/
â”‚   â””â”€â”€ customer_behavior/
â”œâ”€â”€ features/
â”‚   â””â”€â”€ customer_features/
â”œâ”€â”€ segments/
â”‚   â””â”€â”€ customer_segments/
â”œâ”€â”€ recommendations/
â”‚   â””â”€â”€ marketing_targets/
â””â”€â”€ monitoring/
    â””â”€â”€ quality_logs/
```

### Step 2: åˆ›å»ºIAMè§’è‰²

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:GetObject",
        "s3:PutObject",
        "s3:DeleteObject"
      ],
      "Resource": "arn:aws:s3:::your-customer-bucket/*"
    },
    {
      "Effect": "Allow",
      "Action": [
        "glue:*",
        "logs:CreateLogGroup",
        "logs:CreateLogStream",
        "logs:PutLogEvents"
      ],
      "Resource": "*"
    },
    {
      "Effect": "Allow",
      "Action": [
        "cloudwatch:PutMetricData",
        "sns:Publish"
      ],
      "Resource": "*"
    }
  ]
}
```

### Step 3: éƒ¨ç½²Glue Crawler

```bash
aws glue create-crawler \
  --name customer-data-crawler \
  --role arn:aws:iam::YOUR_ACCOUNT:role/GlueServiceRole \
  --database-name customer_raw_db \
  --s3-target '{"Path":"s3://your-bucket/raw/"}' \
  --schedule-expression 'cron(0 0 * * ? *)'
```

### Step 4: åˆ›å»ºGlue Jobs

è¯¦è§åç»­ä»£ç ç¤ºä¾‹ç« èŠ‚

### Step 5: é…ç½®Workflow (å¯é€‰)

åˆ›å»ºGlue WorkflowæŒ‰é¡ºåºæ‰§è¡Œæ‰€æœ‰ä»»åŠ¡

```bash
# ä¾èµ–å…³ç³»
Crawler â†’ Job1(æ¸…æ´—) â†’ Job2(ç‰¹å¾) â†’ Job3(åˆ†ç¾¤) â†’ Job4(æ¨è) â†’ Job5(ç›‘æ§)
```

---

## 6ï¸âƒ£ ç›‘æ§ä¸å‘Šè­¦

### CloudWatch é…ç½®

```yaml
ç›‘æ§æŒ‡æ ‡ï¼š
  - Glue Job æˆåŠŸç‡
  - Job æ‰§è¡Œæ—¶é—´
  - æ•°æ®è¡Œæ•°å˜åŒ–
  - ç¼ºå¤±å€¼ç‡
  - å¼‚å¸¸å€¼æ•°é‡

å‘Šè­¦è§„åˆ™ï¼š
  - Jobå¤±è´¥ â†’ SNSé‚®ä»¶å‘Šè­¦
  - ç¼ºå¤±å€¼ç‡>5% â†’ SNSè­¦å‘Š
  - æ‰§è¡Œæ—¶é—´>é¢„æœŸ150% â†’ SNSé€šçŸ¥
```

### æ•°æ®è´¨é‡æ£€æŸ¥ç‚¹

| æ£€æŸ¥ç‚¹ | è§„åˆ™ | å¤„ç†æ–¹æ¡ˆ |
|-------|------|--------|
| è¡Œæ•°å˜åŒ– | ä¸‹é™>10% | é‡æ–°å¤„ç†+å‘Šè­¦ |
| ç¼ºå¤±å€¼ | >5% | æ ‡è®°+äººå·¥å®¡æ ¸ |
| é‡å¤å€¼ | >0 | å»é‡+è®°å½• |
| å¼‚å¸¸å€¼ | è¶…è¿‡3Ïƒ | éš”ç¦»å¤„ç† |

---

## 7ï¸âƒ£ æˆæœ¬ä¼°ç®—

### æŒ‰æœˆæˆæœ¬ï¼ˆå‡è®¾ï¼‰

| ç»„ä»¶ | ç”¨é‡ | å•ä»· | æœˆæˆæœ¬ |
|-----|------|------|--------|
| Glue Jobs | 30å¤©Ã—5ä»»åŠ¡Ã—0.5å°æ—¶ | $0.44/DPU-å°æ—¶ | ~$30 |
| Glue Crawler | 30æ¬¡çˆ¬å– | å…è´¹é¦–5ä¸ªcrawler | $0 |
| S3å­˜å‚¨ | ~100GB | $0.023/GB | ~$2.3 |
| AthenaæŸ¥è¯¢ | ~100GBæ‰«æ | $5/TB | ~$0.5 |
| CloudWatch | æ—¥å¿—+æŒ‡æ ‡ | ~$5/æœˆ | $5 |
| **æ€»è®¡** | | | **~$37.8** |

---

## 8ï¸âƒ£ åç»­å¢å¼ºåŠŸèƒ½

### çŸ­æœŸï¼ˆ1-2å‘¨ï¼‰
- [ ] å®ç°æ•°æ®æ¸…æ´—Job
- [ ] å®ç°ç‰¹å¾å·¥ç¨‹Job
- [ ] é…ç½®Glue Crawler

### ä¸­æœŸï¼ˆ2-4å‘¨ï¼‰
- [ ] å®¢æˆ·åˆ†ç¾¤ç®—æ³•ä¼˜åŒ–
- [ ] è¥é”€æ¨èæ¨¡å‹è®­ç»ƒ
- [ ] ä¸BIå·¥å…·é›†æˆ

### é•¿æœŸï¼ˆ1-3æœˆï¼‰
- [ ] SageMakeré›†æˆï¼ˆæœºå™¨å­¦ä¹ ï¼‰
- [ ] å®æ—¶æµå¤„ç†ï¼ˆKinesisï¼‰
- [ ] é¢„æµ‹æ¨¡å‹ï¼ˆå®¢æˆ·æµå¤±ã€CLVï¼‰

---

## 9ï¸âƒ£ å‚è€ƒèµ„æº

- AWS Glueæ–‡æ¡£: https://docs.aws.amazon.com/glue/
- PySpark API: https://spark.apache.org/docs/latest/api/python/
- Glueæœ€ä½³å®è·µ: https://docs.aws.amazon.com/glue/latest/dg/best-practices.html
- AWSæ•°æ®æ¹–å‚è€ƒæ¶æ„: https://aws.amazon.com/solutions/implementations/aws-datalake/

---

## ğŸ”Ÿ Q&A

**Q: ä¸ºä»€ä¹ˆé€‰æ‹©Glueè€Œä¸æ˜¯Lambda?**
A: EDAæ•°æ®é‡è¾ƒå¤§ï¼ˆ3000+æ¡è®°å½•ï¼‰ï¼ŒGlueæä¾›Sparkåˆ†å¸ƒå¼å¤„ç†èƒ½åŠ›æ›´é«˜æ•ˆï¼Œä¸”æ”¯æŒå¤æ‚æ•°æ®è½¬æ¢ã€‚

**Q: æ•°æ®å¦‚ä½•ä»æœ¬åœ°è¿ç§»åˆ°S3?**
A: ä½¿ç”¨AWS DataSyncæˆ–CLIä¸Šä¼  â†’ `aws s3 cp customer_base.csv s3://bucket/raw/`

**Q: å¦‚ä½•ç›‘æ§Glueä»»åŠ¡?**
A: CloudWatch Logs + CloudWatch Metrics + è‡ªå®šä¹‰Pythonç›‘æ§è„šæœ¬

**Q: èƒ½å¦æ”¯æŒå®æ—¶å¤„ç†?**
A: ç›®å‰æ–¹æ¡ˆä¸ºæ‰¹å¤„ç†(æ—¥/å‘¨)ï¼Œå¯åæœŸé›†æˆKinesis/Spark Streamingå®ç°å®æ—¶

---

*æ–¹æ¡ˆæ›´æ–°æ—¶é—´ï¼š2025-12-01*
