# Terraform éƒ¨ç½²å®Œæ•´æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æŒ‡å—è¯¦ç»†è¯´æ˜å¦‚ä½•ä½¿ç”¨Terraformè‡ªåŠ¨åŒ–éƒ¨ç½²AWSåŸºç¡€è®¾æ–½ï¼ŒåŒ…æ‹¬ï¼š
- åˆ›å»ºS3 bucketå­˜å‚¨å®¢æˆ·æ•°æ®
- è‡ªåŠ¨ä¸Šä¼ CSVæºæ•°æ®æ–‡ä»¶åˆ°S3
- éƒ¨ç½²AWS Glueæ•°æ®å¤„ç†ç®¡é“
- é…ç½®IAMè§’è‰²å’Œæƒé™
- è®¾ç½®CloudWatchç›‘æ§

---

## ğŸ”§ å‰ç½®æ¡ä»¶

### ç³»ç»Ÿè¦æ±‚
- **Terraform**: >= 1.14.0 (æ£€æŸ¥: `terraform version`)
- **AWS CLI**: >= 2.0 (æ£€æŸ¥: `aws --version`)
- **AWS Account**: æœ‰æ•ˆçš„AWSè´¦å·å’Œé€‚å½“æƒé™

### AWSæƒé™è¦æ±‚

éœ€è¦ä»¥ä¸‹IAMæƒé™ï¼š
- S3: CreateBucket, PutObject, GetObject, ListBucket
- Glue: CreateJob, CreateDatabase, CreateCrawler
- IAM: CreateRole, PutRolePolicy
- CloudWatch: PutMetricAlarm

### æœ¬åœ°æ–‡ä»¶

ç¡®ä¿ä»¥ä¸‹CSVæ–‡ä»¶å­˜åœ¨äºé¡¹ç›®æ ¹ç›®å½•ï¼š
```
CASE-customer-group/
â”œâ”€â”€ customer_base.csv
â”œâ”€â”€ customer_behavior_assets.csv
â””â”€â”€ infra/
    â”œâ”€â”€ main.tf
    â”œâ”€â”€ s3_data_upload.tf
    â”œâ”€â”€ provider.tf
    â””â”€â”€ ...
```

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### æ­¥éª¤ 1: åˆå§‹åŒ–Terraform

```bash
# è¿›å…¥Terraformé…ç½®ç›®å½•
cd infra

# åˆå§‹åŒ–å·¥ä½œç›®å½•ï¼ˆä¸‹è½½AWSæä¾›å•†æ’ä»¶ï¼‰
terraform init

# è¾“å‡ºåº”åŒ…å«:
# Terraform has been successfully configured!
```

**å¯èƒ½çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆï¼š**
- å¦‚æœæç¤ºæ‰¾ä¸åˆ°AWSå‡­è¯ï¼š`aws configure` é…ç½®AWS CLI
- å¦‚æœTerraformç‰ˆæœ¬è¿‡ä½ï¼šå‡çº§Terraformåˆ°1.14+

### æ­¥éª¤ 2: è§„åˆ’éƒ¨ç½²

```bash
# æŸ¥çœ‹Terraformå°†åˆ›å»ºçš„æ‰€æœ‰èµ„æº
terraform plan

# æŸ¥çœ‹è¯¦ç»†çš„planè¾“å‡º
terraform plan -out=tfplan

# é‡è¦ï¼šæ£€æŸ¥è¾“å‡ºä¸­æ˜¯å¦åŒ…æ‹¬ï¼š
# - 1ä¸ªS3 bucket
# - 2ä¸ªCSVæ–‡ä»¶ï¼ˆcustomer_base.csv, customer_behavior_assets.csvï¼‰
# - 5ä¸ªS3ç›®å½•ï¼ˆraw/, cleaned/, features/, scripts/, temp/ï¼‰
# - Glueèµ„æºï¼ˆroles, jobs, databasesç­‰ï¼‰
```

**Planè¾“å‡ºç¤ºä¾‹ï¼š**
```
Terraform will perform the following actions:

  # module.customer_data_bucket.aws_s3_bucket.bucket will be created
  + resource "aws_s3_bucket" "bucket" {
      + bucket = "customer-group-dev-data-123456789"
      + ...
    }

  # aws_s3_object.customer_base_csv will be created
  + resource "aws_s3_object" "customer_base_csv" {
      + bucket = "customer-group-dev-data-123456789"
      + key    = "raw/customer_base.csv"
      + source = "customer_base.csv"
      + etag   = (known after apply)
      ...
    }

Plan: 15 to add, 0 to change, 0 to destroy.
```

### æ­¥éª¤ 3: åº”ç”¨é…ç½®

```bash
# éƒ¨ç½²æ‰€æœ‰èµ„æºåˆ°AWS
terraform apply

# æˆ–ä½¿ç”¨ä¹‹å‰ä¿å­˜çš„plan
terraform apply tfplan

# æç¤ºè¾“å…¥æ—¶è¾“å…¥: yes ç¡®è®¤éƒ¨ç½²
```

**é¢„æœŸè¾“å‡ºï¼š**
```
Apply complete! Resources have been created.

Outputs:

s3_bucket_name = "customer-group-dev-data-123456789"
s3_bucket_arn = "arn:aws:s3:::customer-group-dev-data-123456789"
raw_data_location = "s3://customer-group-dev-data-123456789/raw/"
customer_base_s3_path = "s3://customer-group-dev-data-123456789/raw/customer_base.csv"
customer_behavior_assets_s3_path = "s3://customer-group-dev-data-123456789/raw/customer_behavior_assets.csv"
s3_directory_structure = {
  "raw" = "s3://customer-group-dev-data-123456789/raw/"
  "cleaned" = "s3://customer-group-dev-data-123456789/cleaned/"
  "features" = "s3://customer-group-dev-data-123456789/features/"
  "scripts" = "s3://customer-group-dev-data-123456789/scripts/"
  "temp" = "s3://customer-group-dev-data-123456789/temp/"
}
```

### æ­¥éª¤ 4: éªŒè¯éƒ¨ç½²

```bash
# æŸ¥çœ‹TerraformçŠ¶æ€ä¸­çš„èµ„æº
terraform show

# åˆ—å‡ºS3 bucketå†…å®¹ï¼ˆæ£€æŸ¥CSVæ–‡ä»¶æ˜¯å¦ä¸Šä¼ æˆåŠŸï¼‰
aws s3 ls s3://customer-group-dev-data-123456789/raw/

# è¾“å‡ºåº”æ˜¾ç¤º:
#   2025-12-06 10:30:45    1689829 customer_base.csv
#   2025-12-06 10:30:50   25780197 customer_behavior_assets.csv

# éªŒè¯Glueèµ„æº
aws glue list-jobs --query 'JobNames' --output text

# éªŒè¯IAMè§’è‰²
aws iam get-role --role-name GlueCustomerDataRole
```

---

## ğŸ“Š Terraformèµ„æºè¯¦è§£

### S3 Bucket é…ç½®

**æ–‡ä»¶**: [s3_bucket/main.tf](modules/s3_bucket/main.tf)

åˆ›å»ºçš„S3 bucketåŒ…å«ï¼š
- **ç‰ˆæœ¬æ§åˆ¶**: å¯ç”¨ï¼Œä¾¿äºæ¢å¤å†å²æ•°æ®
- **åŠ å¯†**: å¯ç”¨SSE-S3æœåŠ¡ç«¯åŠ å¯†
- **å…¬å…±è®¿é—®**: å®Œå…¨é˜»æ­¢ï¼Œç¡®ä¿å®‰å…¨

### CSVæ–‡ä»¶ä¸Šä¼ é…ç½®

**æ–‡ä»¶**: [s3_data_upload.tf](s3_data_upload.tf)

é…ç½®æ–‡ä»¶ä¸Šä¼ çš„æ–¹å¼ï¼š
```hcl
resource "aws_s3_object" "customer_base_csv" {
  bucket       = module.customer_data_bucket.bucket_id
  key          = "raw/customer_base.csv"
  source       = "${path.root}/../customer_base.csv"
  etag         = filemd5("${path.root}/../customer_base.csv")  # æ£€æµ‹æ–‡ä»¶å˜åŒ–
  content_type = "text/csv"
  storage_class= "STANDARD"
}
```

**å…³é”®é…ç½®è¯´æ˜ï¼š**
- `bucket`: å¼•ç”¨S3 moduleè¾“å‡º
- `source`: æœ¬åœ°CSVæ–‡ä»¶è·¯å¾„
- `etag`: ä½¿ç”¨æ–‡ä»¶MD5å“ˆå¸Œï¼Œæ£€æµ‹æ›´æ”¹å¹¶è‡ªåŠ¨ä¸Šä¼ æ–°ç‰ˆæœ¬
- `depends_on`: ç¡®ä¿å…ˆåˆ›å»ºraw/ç›®å½•

### Glue Pipeline é…ç½®

**æ–‡ä»¶**: [modules/glue/](modules/glue/)

åŒ…å«ï¼š
- **IAMè§’è‰²**: GlueCustomerDataRoleï¼Œå…·æœ‰S3å’ŒGlue Catalogæƒé™
- **Glue Job**:
  - customer-data-cleansing (æ•°æ®æ¸…æ´—)
  - customer-feature-engineering (ç‰¹å¾å·¥ç¨‹)
- **Glue Databases**:
  - customer_raw_db (åŸå§‹æ•°æ®)
  - customer_cleaned_db (æ¸…æ´—æ•°æ®)
  - customer_feature_db (ç‰¹å¾æ•°æ®)
- **CloudWatch Logs**: è‡ªåŠ¨é…ç½®jobæ—¥å¿—

---

## ğŸ”„ æ›´æ–°å’Œä¿®æ”¹

### æ›´æ–°CSVæ–‡ä»¶

å¦‚æœæœ¬åœ°CSVæ–‡ä»¶æ›´æ–°ï¼ŒTerraformä¼šè‡ªåŠ¨æ£€æµ‹å¹¶é‡æ–°ä¸Šä¼ ï¼š

```bash
# Terraformä¼šæ˜¾ç¤ºæ–‡ä»¶å·²æ›´æ”¹
terraform plan

# åº”ç”¨æ›´æ–°
terraform apply
```

**å·¥ä½œåŸç†**ï¼šTerraformä½¿ç”¨æ–‡ä»¶MD5å“ˆå¸Œï¼ˆetagï¼‰æ£€æµ‹æ–‡ä»¶å˜åŒ–ï¼Œå¦‚æœæœ¬åœ°æ–‡ä»¶æ›´æ”¹ï¼Œetagä¼šå˜åŒ–ï¼Œè§¦å‘S3ä¸Šä¼ ã€‚

### ä¿®æ”¹Terraformå˜é‡

ç¼–è¾‘ `terraform.tfvars`:

```hcl
# ä¿®æ”¹ç¯å¢ƒ
environment = "prod"

# ä¿®æ”¹é¡¹ç›®å
project_name = "customer-analytics"

# ä¿®æ”¹AWSåŒºåŸŸ
aws_region = "us-west-2"
```

ç„¶åé‡æ–°éƒ¨ç½²ï¼š

```bash
terraform plan
terraform apply
```

### æ·»åŠ æ–°çš„Glue Job

1. ç¼–è¾‘ `glue_scripts/config/glue_jobs_config.json` æ·»åŠ æ–°jobé…ç½®
2. è¿è¡Œï¼š
```bash
terraform plan  # æŸ¥çœ‹æ–°èµ„æº
terraform apply # åˆ›å»ºæ–°èµ„æº
```

---

## ğŸ“ TerraformçŠ¶æ€ç®¡ç†

### æŸ¥çœ‹å½“å‰çŠ¶æ€

```bash
# æ˜¾ç¤ºTerraformæ‰˜ç®¡çš„æ‰€æœ‰èµ„æº
terraform show

# åˆ—å‡ºèµ„æºæ‘˜è¦
terraform state list

# æŸ¥çœ‹ç‰¹å®šèµ„æºè¯¦æƒ…
terraform state show module.customer_data_bucket.aws_s3_bucket.bucket
```

### å¤‡ä»½çŠ¶æ€

Terraformåœ¨æœ¬åœ°ç®¡ç†çŠ¶æ€æ–‡ä»¶ (`terraform.tfstate`)ï¼š

```bash
# å¤‡ä»½å½“å‰çŠ¶æ€
cp terraform.tfstate terraform.tfstate.backup

# å»ºè®®ï¼šå°†çŠ¶æ€æ–‡ä»¶å­˜å‚¨åœ¨è¿œç¨‹ä½ç½®ï¼ˆS3/Terraform Cloudï¼‰
# è¿™å¯ä»¥é€šè¿‡ backend é…ç½®å®Œæˆï¼ˆè§ä¸‹ä¸€èŠ‚ï¼‰
```

### ä½¿ç”¨è¿œç¨‹çŠ¶æ€å­˜å‚¨ï¼ˆå¯é€‰ï¼‰

åˆ›å»º `backend.tf` ä½¿ç”¨S3å­˜å‚¨çŠ¶æ€ï¼š

```hcl
terraform {
  backend "s3" {
    bucket         = "your-terraform-state-bucket"
    key            = "customer-group/terraform.tfstate"
    region         = "us-east-1"
    encrypt        = true
    dynamodb_table = "terraform-locks"
  }
}
```

---

## ğŸ—‘ï¸ æ¸…ç†èµ„æº

### åˆ é™¤æ‰€æœ‰Terraformåˆ›å»ºçš„èµ„æº

```bash
# æŸ¥çœ‹è¦åˆ é™¤çš„èµ„æº
terraform plan -destroy

# æ‰§è¡Œåˆ é™¤
terraform destroy

# ç¡®è®¤è¾“å…¥: yes
```

**è­¦å‘Š**ï¼š`terraform destroy` ä¼šåˆ é™¤æ‰€æœ‰èµ„æºï¼ŒåŒ…æ‹¬S3ä¸­çš„æ•°æ®ã€‚å¦‚æœæƒ³ä¿ç•™æ•°æ®ï¼Œéœ€è¦æ‰‹åŠ¨å¤‡ä»½ã€‚

### ä¿ç•™ç‰¹å®šèµ„æº

å¦‚æœæƒ³åˆ é™¤æŸäº›èµ„æºä½†ä¿ç•™S3æ•°æ®ï¼š

```bash
# ä»TerraformçŠ¶æ€ä¸­ç§»é™¤S3å¯¹è±¡ï¼ˆä½†ä¸åˆ é™¤å®é™…S3æ•°æ®ï¼‰
terraform state rm aws_s3_object.customer_base_csv
terraform state rm aws_s3_object.customer_behavior_assets_csv

# ç„¶åè¿è¡Œdestroyï¼ŒS3å¯¹è±¡ä¼šè¢«Terraformå¿½ç•¥
terraform destroy
```

---

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: "æ‰¾ä¸åˆ°customer_base.csv"

```bash
# é”™è¯¯ä¿¡æ¯
Error: open ../customer_base.csv: file does not exist

# è§£å†³æ–¹æ¡ˆ
# 1. æ£€æŸ¥æ–‡ä»¶ä½ç½®
ls ../customer_base.csv

# 2. ç¡®ä¿åœ¨infra/ç›®å½•ä¸­è¿è¡Œterraform
cd infra

# 3. å¦‚æœæ–‡ä»¶åœ¨å…¶ä»–ä½ç½®ï¼Œæ›´æ–°s3_data_upload.tfä¸­çš„è·¯å¾„
# ç¼–è¾‘: source = "${path.root}/../customer_base.csv"
```

### é—®é¢˜ 2: AWSæƒé™ä¸è¶³

```bash
# é”™è¯¯ä¿¡æ¯
AccessDenied: User is not authorized to perform: s3:CreateBucket

# è§£å†³æ–¹æ¡ˆ
# 1. æ£€æŸ¥AWSå‡­è¯
aws sts get-caller-identity

# 2. ç¡®ä¿IAMç”¨æˆ·æœ‰S3å’ŒGlueæƒé™
# 3. æŸ¥çœ‹CloudTrailæ—¥å¿—äº†è§£å…·ä½“æƒé™ç¼ºå¤±
```

### é—®é¢˜ 3: Terraformç‰ˆæœ¬ä¸å…¼å®¹

```bash
# é”™è¯¯ä¿¡æ¯
Error: Unsupported block type

# è§£å†³æ–¹æ¡ˆ
# æ›´æ–°Terraform
terraform version  # æ£€æŸ¥å½“å‰ç‰ˆæœ¬
# è®¿é—® https://www.terraform.io/downloads ä¸‹è½½1.14+ç‰ˆæœ¬
```

### é—®é¢˜ 4: S3 bucketåç§°å†²çª

```bash
# é”™è¯¯ä¿¡æ¯
Error: Error creating S3 bucket: BucketAlreadyOwnedByYou

# è§£å†³æ–¹æ¡ˆ
# S3 bucketåç§°åœ¨AWSå…¨å±€å”¯ä¸€
# Terraformä½¿ç”¨account IDç”Ÿæˆå”¯ä¸€åç§°ï¼š
# customer-group-dev-data-{account-id}
# å¦‚æœä»å†²çªï¼Œä¿®æ”¹project_nameå˜é‡
```

---

## ğŸ“ˆ æˆæœ¬ä¼°ç®—

æ ¹æ®å…¸å‹ç”¨æ³•ï¼ˆæœˆåº¦æ•°æ®å¤„ç†ï¼‰ï¼š

| èµ„æº | ç”¨é€” | ä¼°è®¡æˆæœ¬ |
|------|------|---------|
| S3 Storage | æ•°æ®å­˜å‚¨ (~5GB) | $0.10 |
| S3 API | PUT/GETè¯·æ±‚ | $0.05 |
| Glue DPU | æ•°æ®å¤„ç† (4 DPUÃ—2h/day) | $15.00 |
| **æ€»è®¡** | **æœˆåº¦æˆæœ¬** | **~$15/month** |

ä¼˜åŒ–æˆæœ¬çš„æ–¹æ³•ï¼š
1. é™ä½Glue DPUæ•°é‡ï¼ˆåœ¨glue_jobs_config.jsonä¸­ï¼‰
2. ä½¿ç”¨S3ç”Ÿå‘½å‘¨æœŸç­–ç•¥åˆ é™¤æ—§ä¸´æ—¶æ–‡ä»¶
3. å®šæœŸæ¸…ç†ä¸éœ€è¦çš„processed data

---

## âœ… éƒ¨ç½²æ£€æŸ¥æ¸…å•

- [ ] Terraformç‰ˆæœ¬ >= 1.14.0
- [ ] AWS CLIå·²é…ç½® (`aws configure`)
- [ ] CSVæ–‡ä»¶ä½äºé¡¹ç›®æ ¹ç›®å½•
- [ ] æ‰§è¡Œ `terraform init`
- [ ] æ‰§è¡Œ `terraform plan` å¹¶æ£€æŸ¥è¾“å‡º
- [ ] æ‰§è¡Œ `terraform apply` ç¡®è®¤éƒ¨ç½²
- [ ] éªŒè¯S3ä¸­çš„CSVæ–‡ä»¶: `aws s3 ls s3://bucket-name/raw/`
- [ ] éªŒè¯Glue Jobs: `aws glue list-jobs`
- [ ] æ£€æŸ¥CloudWatchæ—¥å¿—

---

## ğŸ“š æ›´å¤šèµ„æº

- [Terraform AWSæä¾›å•†æ–‡æ¡£](https://registry.terraform.io/providers/hashicorp/aws/latest/docs)
- [AWS Glueæ–‡æ¡£](https://docs.aws.amazon.com/glue/)
- [S3æœ€ä½³å®è·µ](https://docs.aws.amazon.com/AmazonS3/latest/userguide/BestPractices.html)
- [Terraformæœ€ä½³å®è·µ](https://www.terraform.io/cloud-docs/recommended-practices)

---

**æœ€åæ›´æ–°**: 2025-12-06
**ç»´æŠ¤è€…**: Data Engineering Team
